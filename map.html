<!DOCTYPE html>
<html>
<head>
    <title>–ó–∞–∫–∞–∑ –¢–∞–∫—Å–∏</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f3f2; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞ –∫–∞–∫ –≤ –Ø–Ω–¥–µ–∫—Å–µ */
        .input-group { margin-bottom: 12px; position: relative; }
        .input-icon { position: absolute; left: 12px; top: 12px; font-size: 16px; }
        input {
            width: 100%; box-sizing: border-box; background: #f5f5f5; border: none;
            padding: 14px 14px 14px 40px; border-radius: 12px; font-size: 16px; font-weight: 500;
            outline: none;
        }
        input:focus { background: #ebebeb; }
        
        .price-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-size: 18px; font-weight: bold; }
        
        .main-btn {
            width: 100%; background: #ffde00; color: black; border: none;
            padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px;
            cursor: pointer;
        }
        .main-btn:disabled { background: #f5f5f5; color: #999; cursor: not-allowed; }
        
        .custom-icon { background: none; border: none; }
        .marker-a { background: #000; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);}
        .marker-b { background: #ffde00; color: black; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);}
        
        .reset-btn { position: fixed; top: 15px; right: 15px; background: white; width: 40px; height: 40px; border-radius: 20px; display: flex; align-items: center; justify-content: center; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 20px; cursor: pointer; display: none;}
        .reset-btn.active { display: flex; }
    </style>
</head>
<body>

<div id="map"></div>
<div class="reset-btn" id="reset-btn" onclick="resetMap()">‚úñ</div>

<div class="bottom-sheet" id="sheet">
    <div class="input-group">
        <div class="input-icon">üìç</div>
        <!-- onchange —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ –Ω–∞–∂–∞–ª Enter –∏–ª–∏ –∫–ª–∏–∫–Ω—É–ª –º–∏–º–æ -->
        <input type="text" id="input-from" placeholder="–û—Ç–∫—É–¥–∞ –ø–æ–µ–¥–µ–º?" onchange="searchAddress(this.value, true)">
    </div>
    <div class="input-group">
        <div class="input-icon">üèÅ</div>
        <input type="text" id="input-to" placeholder="–ö—É–¥–∞ –ø–æ–µ–¥–µ–º?" onchange="searchAddress(this.value, false)">
    </div>
    <div class="price-row">
        <span>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
        <span id="price-val">~ —Ä—É–±.</span>
    </div>
    <button class="main-btn" id="order-btn" onclick="sendOrder()" disabled>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    const map = L.map('map', {zoomControl: false}).setView([58.6035, 49.6680], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

    let markerA = null, markerB = null, routeLine = null;
    let orderData = { from: "", to: "", price: 0, distance: 0 };
    const iconA = L.divIcon({className: 'custom-icon', html: '<div class="marker-a">A</div>', iconSize: [30, 30], iconAnchor: [15, 15]});
    const iconB = L.divIcon({className: 'custom-icon', html: '<div class="marker-b">B</div>', iconSize: [30, 30], iconAnchor: [15, 15]});

    // –£–º–Ω—ã–π –ø–æ–∏—Å–∫ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∞–¥—Ä–µ—Å–∞
    async function getAddress(lat, lon) {
        try {
            let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ru`);
            let data = await res.json();
            if(data.address) {
                let street = data.address.road || data.address.pedestrian || data.address.suburb;
                if (street) {
                    return street + (data.address.house_number ? ", " + data.address.house_number : "");
                }
            }
            // –ï—Å–ª–∏ —É–ª–∏—Ü—ã –Ω–µ—Ç, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –¥–ª–∏–Ω–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
            if (data.display_name) {
                return data.display_name.split(',')[0];
            }
            return "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã";
        } catch(e) { return "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; }
    }

    // –ï—Å–ª–∏ –≤–≤–µ–ª–∏ —Ç–µ–∫—Å—Ç —Ä—É—á–∫–∞–º–∏
    async function searchAddress(query, isPointA) {
        if(!query) return;
        try {
            let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=–ö–∏—Ä–æ–≤ ${query}&limit=1`);
            let data = await res.json();
            if(data.length > 0) {
                let latlng = L.latLng(data[0].lat, data[0].lon);
                map.setView(latlng, 15);
                placeMarker(latlng, isPointA, query); // –°—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä
            }
        } catch(e) {}
    }

    async function placeMarker(latlng, isPointA, forceName = null) {
        document.getElementById('reset-btn').classList.add('active');
        
        let addr = forceName || await getAddress(latlng.lat, latlng.lng);
        
        if (isPointA) {
            if(!markerA) { 
                markerA = L.marker(latlng, {icon: iconA, draggable: true}).addTo(map); 
                markerA.on('dragend', function() { placeMarker(markerA.getLatLng(), true); });
            }
            else markerA.setLatLng(latlng);
            
            orderData.from = addr;
            document.getElementById('input-from').value = addr;
        } else {
            if(!markerB) { 
                markerB = L.marker(latlng, {icon: iconB, draggable: true}).addTo(map); 
                markerB.on('dragend', function() { placeMarker(markerB.getLatLng(), false); });
            }
            else markerB.setLatLng(latlng);
            
            orderData.to = addr;
            document.getElementById('input-to').value = addr;
        }

        if (markerA && markerB) await drawRouteAndCalculate(markerA.getLatLng(), markerB.getLatLng());
    }

    map.on('click', function(e) {
        if (!markerA) placeMarker(e.latlng, true);
        else if (!markerB) placeMarker(e.latlng, false);
    });

    function resetMap() {
        if(markerA) map.removeLayer(markerA);
        if(markerB) map.removeLayer(markerB);
        if(routeLine) map.removeLayer(routeLine);
        markerA = markerB = routeLine = null;
        orderData = { from: "", to: "", price: 0, distance: 0 };
        document.getElementById('reset-btn').classList.remove('active');
        document.getElementById('input-from').value = "";
        document.getElementById('input-to').value = "";
        document.getElementById('price-val').innerText = "~ —Ä—É–±.";
        document.getElementById('order-btn').innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç";
        document.getElementById('order-btn').disabled = true;
    }

    async function drawRouteAndCalculate(start, end) {
        if(routeLine) map.removeLayer(routeLine);
        document.getElementById('price-val').innerText = "–°—á–∏—Ç–∞–µ–º...";
        try {
            let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`);
            let data = await res.json();
            if(data.routes && data.routes.length > 0) {
                let route = data.routes[0];
                let distanceKm = (route.distance / 1000).toFixed(1);
                orderData.distance = distanceKm;
                orderData.price = Math.round(100 + (distanceKm * 20));
                
                document.getElementById('price-val').innerText = orderData.price + " —Ä—É–±.";
                routeLine = L.geoJSON(route.geometry, { style: {color: '#007aff', weight: 5, opacity: 0.8} }).addTo(map);
                
                document.getElementById('order-btn').innerText = "–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏";
                document.getElementById('order-btn').disabled = false;
            }
        } catch(e) {}
    }

    function sendOrder() {
        if(orderData.from && orderData.to && orderData.price > 0) {
            tg.sendData(JSON.stringify(orderData));
            tg.close();
        }
    }
</script>
</body>
</html>
