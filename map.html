<!DOCTYPE html>
<html>
<head>
    <title>–ó–∞–∫–∞–∑ –¢–∞–∫—Å–∏</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f3f2; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        /* –î–∏–∑–∞–π–Ω –≤ —Å—Ç–∏–ª–µ –Ø–Ω–¥–µ–∫—Å–∞ (—à—Ç–æ—Ä–∫–∞ —Å–Ω–∏–∑—É) */
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 1000; transform: translateY(100%); transition: transform 0.3s ease-out;
        }
        .bottom-sheet.active { transform: translateY(0); }
        
        .address-box { margin-bottom: 15px; }
        .address-title { font-size: 12px; color: #888; margin-bottom: 4px; text-transform: uppercase; font-weight: bold; }
        .address-value { font-size: 16px; font-weight: 500; color: #000; padding: 10px; background: #f5f5f5; border-radius: 10px; }
        
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 18px; font-weight: bold; }
        
        button {
            width: 100%; background: #ffde00; color: black; border: none;
            padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px;
            cursor: pointer; transition: background 0.2s;
        }
        button:active { background: #e6c800; }
        
        /* –°—Ç–∏–ª–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ */
        .custom-icon { background: none; border: none; }
        .marker-a { background: #000; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);}
        .marker-b { background: #ffde00; color: black; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);}
    </style>
</head>
<body>

<div id="map"></div>

<div class="bottom-sheet" id="sheet">
    <div class="address-box">
        <div class="address-title">üìç –û—Ç–∫—É–¥–∞ –∑–∞–±—Ä–∞—Ç—å</div>
        <div class="address-value" id="addr-from">–û–ø—Ä–µ–¥–µ–ª—è–µ–º...</div>
    </div>
    <div class="address-box">
        <div class="address-title">üèÅ –ö—É–¥–∞ –ø–æ–µ–¥–µ–º</div>
        <div class="address-value" id="addr-to">–û–ø—Ä–µ–¥–µ–ª—è–µ–º...</div>
    </div>
    <div class="price-row">
        <span>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
        <span id="price-val">~ —Ä—É–±.</span>
    </div>
    <button onclick="sendOrder()">–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    tg.ready();

    // –ö—Ä–∞—Å–∏–≤—ã–π —Å—Ç–∏–ª—å –∫–∞—Ä—Ç—ã (–°–≤–µ—Ç–ª—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω)
    const map = L.map('map', {zoomControl: false}).setView([58.6035, 49.6680], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap ¬© CartoDB',
        maxZoom: 19
    }).addTo(map);

    let markerA = null, markerB = null;
    let routeLine = null;
    let orderData = { from: "", to: "", price: 0, distance: 0 };

    const iconA = L.divIcon({className: 'custom-icon', html: '<div class="marker-a">A</div>', iconSize: [30, 30], iconAnchor: [15, 15]});
    const iconB = L.divIcon({className: 'custom-icon', html: '<div class="marker-b">B</div>', iconSize: [30, 30], iconAnchor: [15, 15]});

    map.on('click', async function(e) {
        if (!markerA) {
            markerA = L.marker(e.latlng, {icon: iconA}).addTo(map);
            let addr = await getAddress(e.latlng.lat, e.latlng.lng);
            orderData.from = addr;
            document.getElementById('addr-from').innerText = addr;
        } else if (!markerB) {
            markerB = L.marker(e.latlng, {icon: iconB}).addTo(map);
            let addr = await getAddress(e.latlng.lat, e.latlng.lng);
            orderData.to = addr;
            document.getElementById('addr-to').innerText = addr;
            
            // –ö–∞–∫ —Ç–æ–ª—å–∫–æ –µ—Å—Ç—å 2 —Ç–æ—á–∫–∏ - —Å—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
            await drawRouteAndCalculate(markerA.getLatLng(), markerB.getLatLng());
            document.getElementById('sheet').classList.add('active');
        } else {
            // –°–±—Ä–æ—Å, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ 3-–π —Ä–∞–∑
            map.removeLayer(markerA);
            map.removeLayer(markerB);
            if(routeLine) map.removeLayer(routeLine);
            markerA = markerB = routeLine = null;
            document.getElementById('sheet').classList.remove('active');
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ —É–ª–∏—Ü—É (–û–±—Ä–∞—Ç–Ω–æ–µ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
    async function getAddress(lat, lon) {
        try {
            let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            let data = await res.json();
            if(data.address) {
                let street = data.address.road || "–£–ª–∏—Ü–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞";
                let house = data.address.house_number ? ", " + data.address.house_number : "";
                return street + house;
            }
            return "–ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω";
        } catch(e) { return "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"; }
    }

    // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç –ø–æ –¥–æ—Ä–æ–≥–∞–º –∏ —Å—á–∏—Ç–∞–µ–º —Ü–µ–Ω—É
    async function drawRouteAndCalculate(start, end) {
        try {
            // –û–±—Ä–∞—â–∞–µ–º—Å—è –∫ –æ—Ç–∫—Ä—ã—Ç–æ–º—É —Å–µ—Ä–≤–µ—Ä—É –º–∞—Ä—à—Ä—É—Ç–æ–≤ OSRM
            let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`);
            let data = await res.json();
            
            if(data.routes && data.routes.length > 0) {
                let route = data.routes[0];
                let distanceKm = (route.distance / 1000).toFixed(1); // –î–∏—Å—Ç–∞–Ω—Ü–∏—è –≤ –∫–º
                orderData.distance = distanceKm;
                
                // –§–æ—Ä–º—É–ª–∞ —Ü–µ–Ω—ã: 100 —Ä—É–± –ø–æ—Å–∞–¥–∫–∞ + 20 —Ä—É–± –∑–∞ –∫–∞–∂–¥—ã–π –∫–º
                let calculatedPrice = Math.round(100 + (distanceKm * 20));
                orderData.price = calculatedPrice;
                document.getElementById('price-val').innerText = calculatedPrice + " —Ä—É–±.";

                // –†–∏—Å—É–µ–º —Å–∏–Ω—é—é –ª–∏–Ω–∏—é –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
                routeLine = L.geoJSON(route.geometry, { style: {color: '#007aff', weight: 5, opacity: 0.8} }).addTo(map);
                map.fitBounds(routeLine.getBounds(), {padding: [50, 50]}); // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
            }
        } catch(e) {
            console.log("–û—à–∏–±–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞");
        }
    }

    function sendOrder() {
        if(orderData.from && orderData.to) {
            tg.sendData(JSON.stringify(orderData));
            tg.close();
        }
    }
</script>
</body>
</html>
