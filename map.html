<!DOCTYPE html>
<html>
<head>
    <title>–ó–∞–∫–∞–∑ –¢–∞–∫—Å–∏</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background-color: #f3f3f2; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); z-index: 1000; }
        .input-group { margin-bottom: 12px; position: relative; }
        .input-icon { position: absolute; left: 12px; top: 12px; font-size: 16px; }
        input { width: 100%; box-sizing: border-box; background: #f5f5f5; border: none; padding: 14px 14px 14px 40px; border-radius: 12px; font-size: 16px; font-weight: 500; outline: none; }
        .price-row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-size: 18px; font-weight: bold; }
        .main-btn { width: 100%; background: #ffde00; color: black; border: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .main-btn:disabled { background: #f5f5f5; color: #999; cursor: not-allowed; }
        .custom-icon { background: none; border: none; }
        .marker-a { background: #000; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white;}
        .marker-b { background: #ffde00; color: black; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white;}
        .reset-btn { position: fixed; top: 15px; right: 15px; background: white; width: 40px; height: 40px; border-radius: 20px; display: flex; align-items: center; justify-content: center; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 20px; cursor: pointer; display: none;}
        .reset-btn.active { display: flex; }
    </style>
</head>
<body>

<div id="map"></div>
<div class="reset-btn" id="reset-btn" onclick="resetMap()">‚úñ</div>
<div class="bottom-sheet" id="sheet">
    <div class="input-group">
        <div class="input-icon">üìç</div>
        <input type="text" id="input-from" placeholder="–û—Ç–∫—É–¥–∞ –ø–æ–µ–¥–µ–º? (–ì–æ—Ä–æ–¥, –£–ª–∏—Ü–∞)" onchange="searchAddress(this.value, true)">
    </div>
    <div class="input-group">
        <div class="input-icon">üèÅ</div>
        <input type="text" id="input-to" placeholder="–ö—É–¥–∞ –ø–æ–µ–¥–µ–º? (–ì–æ—Ä–æ–¥, –£–ª–∏—Ü–∞)" onchange="searchAddress(this.value, false)">
    </div>
    <div class="price-row"><span>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å:</span><span id="price-val">~ —Ä—É–±.</span></div>
    <button class="main-btn" id="order-btn" onclick="sendOrder()" disabled>–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</button>
</div>

<script>
    const tg = window.Telegram.WebApp; tg.expand(); tg.ready();
    const map = L.map('map', {zoomControl: false}).setView([58.6035, 49.6680], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

    let markerA = null, markerB = null, routeLine = null;
    // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–∏–ª–∏ –ø—É—Å—Ç—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –Ω–∞—á–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç
    let orderData = { from: "", to: "", price: 0, distance: 0, latA: 0, lonA: 0, latB: 0, lonB: 0 };
    
    const iconA = L.divIcon({className: 'custom-icon', html: '<div class="marker-a">A</div>', iconSize: [30, 30], iconAnchor: [15, 15]});
    const iconB = L.divIcon({className: 'custom-icon', html: '<div class="marker-b">B</div>', iconSize: [30, 30], iconAnchor: [15, 15]});

    L.Control.geocoder({ defaultMarkGeocode: false, placeholder: "–ü–æ–∏—Å–∫..." }).on('markgeocode', function(e) {
        let latlng = e.geocode.center; map.setView(latlng, 16);
        if (!markerA) placeMarker(latlng, true); else if (!markerB) placeMarker(latlng, false);
    }).addTo(map);

    async function getAddress(lat, lon) {
        try {
            let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ru`);
            let data = await res.json();
            if(data.address) return (data.address.road || data.address.pedestrian || data.address.suburb || "–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ") + (data.address.house_number ? ", " + data.address.house_number : "");
            if (data.display_name) return data.display_name.split(',')[0];
            return "–¢–æ—á–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ";
        } catch(e) { return "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã"; }
    }

    async function searchAddress(query, isPointA) {
        if(!query) return;
        try {
            let res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=–ö–∏—Ä–æ–≤ ${query}&limit=1`);
            let data = await res.json();
            if(data.length > 0) {
                let latlng = L.latLng(data[0].lat, data[0].lon); map.setView(latlng, 16); placeMarker(latlng, isPointA, query);
            } else tg.showAlert("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É!");
        } catch(e) {}
    }

    async function placeMarker(latlng, isPointA, forceName = null) {
        document.getElementById('reset-btn').classList.add('active');
        let addr = forceName || await getAddress(latlng.lat, latlng.lng);
        
        if (isPointA) {
            if(!markerA) { markerA = L.marker(latlng, {icon: iconA, draggable: true}).addTo(map); markerA.on('dragend', function() { placeMarker(markerA.getLatLng(), true); }); }
            else markerA.setLatLng(latlng);
            orderData.from = addr; document.getElementById('input-from').value = addr;
            orderData.latA = latlng.lat; orderData.lonA = latlng.lng; // –°–û–•–†–ê–ù–Ø–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´!
        } else {
            if(!markerB) { markerB = L.marker(latlng, {icon: iconB, draggable: true}).addTo(map); markerB.on('dragend', function() { placeMarker(markerB.getLatLng(), false); }); }
            else markerB.setLatLng(latlng);
            orderData.to = addr; document.getElementById('input-to').value = addr;
            orderData.latB = latlng.lat; orderData.lonB = latlng.lng; // –°–û–•–†–ê–ù–Ø–ï–ú –ö–û–û–†–î–ò–ù–ê–¢–´!
        }
        if (markerA && markerB) await drawRouteAndCalculate(markerA.getLatLng(), markerB.getLatLng());
    }

    map.on('click', function(e) { if (!markerA) placeMarker(e.latlng, true); else if (!markerB) placeMarker(e.latlng, false); });

    function resetMap() {
        if(markerA) map.removeLayer(markerA); if(markerB) map.removeLayer(markerB); if(routeLine) map.removeLayer(routeLine);
        markerA = markerB = routeLine = null; orderData = { from: "", to: "", price: 0, distance: 0, latA: 0, lonA: 0, latB: 0, lonB: 0 };
        document.getElementById('reset-btn').classList.remove('active'); document.getElementById('input-from').value = ""; document.getElementById('input-to').value = "";
        document.getElementById('price-val').innerText = "~ —Ä—É–±."; document.getElementById('order-btn').innerText = "–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç"; document.getElementById('order-btn').disabled = true;
    }

    async function drawRouteAndCalculate(start, end) {
        if(routeLine) map.removeLayer(routeLine); document.getElementById('price-val').innerText = "–°—á–∏—Ç–∞–µ–º...";
        try {
            let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`);
            let data = await res.json();
            if(data.routes && data.routes.length > 0) {
                let route = data.routes[0];
                let distanceKm = (route.distance / 1000).toFixed(1);
                orderData.distance = distanceKm;
                
                // –ù–û–í–ê–Ø –≠–ö–û–ù–û–ú–ò–ö–ê: 90 —Ä—É–±–ª–µ–π –ø–æ—Å–∞–¥–∫–∞ + 20 —Ä—É–±–ª–µ–π –∑–∞ –∫–∞–∂–¥—ã–π –∫–∏–ª–æ–º–µ—Ç—Ä
                orderData.price = Math.round(90 + (distanceKm * 20)); 
                
                document.getElementById('price-val').innerText = orderData.price + " —Ä—É–±.";
                routeLine = L.geoJSON(route.geometry, { style: {color: '#007aff', weight: 5, opacity: 0.8} }).addTo(map);
                map.fitBounds(routeLine.getBounds(), {padding: [30, 30]});
                document.getElementById('order-btn').innerText = "–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏"; document.getElementById('order-btn').disabled = false;
            }
        } catch(e) { document.getElementById('price-val').innerText = "–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞"; }
    }

    function sendOrder() {
        if(orderData.from && orderData.to && orderData.price > 0 && orderData.latA !== 0) {
            tg.sendData(JSON.stringify(orderData)); tg.close();
        } else tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –æ–±–µ —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ.");
    }
</script>
</body>
</html>
