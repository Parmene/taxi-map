<!DOCTYPE html>
<html>
<head>
    <title>–ó–∞–∫–∞–∑ –¢–∞–∫—Å–∏</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- –ü–ª–∞–≥–∏–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ (–ì–µ–æ–∫–æ–¥–µ—Ä) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f3f2; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 1000; transform: translateY(100%); transition: transform 0.3s ease-out;
            max-height: 50vh; overflow-y: auto;
        }
        .bottom-sheet.active { transform: translateY(0); }
        
        .address-box { margin-bottom: 15px; }
        .address-title { font-size: 12px; color: #888; margin-bottom: 4px; text-transform: uppercase; font-weight: bold; }
        .address-value { font-size: 16px; font-weight: 500; color: #000; padding: 10px; background: #f5f5f5; border-radius: 10px; word-wrap: break-word; }
        
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 18px; font-weight: bold; }
        
        button {
            width: 100%; background: #ffde00; color: black; border: none;
            padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px;
            cursor: pointer; transition: background 0.2s;
        }
        button:active { background: #e6c800; }
        
        .custom-icon { background: none; border: none; }
        .marker-a { background: #000; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);}
        .marker-b { background: #ffde00; color: black; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);}
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ (–ö—Ä–µ—Å—Ç–∏–∫) */
        .reset-btn { position: fixed; top: 15px; right: 15px; background: white; width: 40px; height: 40px; border-radius: 20px; display: flex; align-items: center; justify-content: center; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 20px; cursor: pointer; display: none;}
        .reset-btn.active { display: flex; }
    </style>
</head>
<body>

<div id="map"></div>
<div class="reset-btn" id="reset-btn" onclick="resetMap()">‚úñ</div>

<div class="bottom-sheet" id="sheet">
    <div class="address-box">
        <div class="address-title">üìç –û—Ç–∫—É–¥–∞ –∑–∞–±—Ä–∞—Ç—å (–¢–æ—á–∫–∞ –ê)</div>
        <div class="address-value" id="addr-from">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É...</div>
    </div>
    <div class="address-box">
        <div class="address-title">üèÅ –ö—É–¥–∞ –ø–æ–µ–¥–µ–º (–¢–æ—á–∫–∞ B)</div>
        <div class="address-value" id="addr-to">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É...</div>
    </div>
    <div class="price-row">
        <span>üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
        <span id="price-val">~ —Ä—É–±.</span>
    </div>
    <button id="order-btn" onclick="sendOrder()">–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();

    // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã (–ö–∏—Ä–æ–≤)
    const map = L.map('map', {zoomControl: false}).setView([58.6035, 49.6680], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        maxZoom: 19
    }).addTo(map);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–∞
    L.Control.geocoder({
        defaultMarkGeocode: false, // –ù–µ —Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–∞—Ä–∫–µ—Ä
        placeholder: "–ü–æ–∏—Å–∫ —É–ª–∏—Ü—ã, –¥–æ–º–∞..."
    }).on('markgeocode', function(e) {
        // –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–¥—Ä–µ—Å–∞ –≤ –ø–æ–∏—Å–∫–µ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –Ω–µ–º
        let latlng = e.geocode.center;
        map.setView(latlng, 16);
    }).addTo(map);

    let markerA = null, markerB = null;
    let routeLine = null;
    let orderData = { from: "", to: "", price: 0, distance: 0 };

    const iconA = L.divIcon({className: 'custom-icon', html: '<div class="marker-a">A</div>', iconSize: [30, 30], iconAnchor: [15, 15]});
    const iconB = L.divIcon({className: 'custom-icon', html: '<div class="marker-b">B</div>', iconSize: [30, 30], iconAnchor: [15, 15]});

    // –§—É–Ω–∫—Ü–∏—è: –ø–µ—Ä–µ–≤–æ–¥–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –∞–¥—Ä–µ—Å (–∏–ª–∏ –æ—Ç–¥–∞–µ–º —Å–∞–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ)
    async function getAddress(lat, lon) {
        try {
            let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ru`);
            let data = await res.json();
            if(data.address) {
                let street = data.address.road || data.address.pedestrian || data.address.suburb || "–û–±—ä–µ–∫—Ç –±–µ–∑ —É–ª–∏—Ü—ã";
                let house = data.address.house_number ? ", " + data.address.house_number : "";
                return street + house;
            }
            return `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        } catch(e) { 
            return `–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(4)}, ${lon.toFixed(4)}`; 
        }
    }

    // –§—É–Ω–∫—Ü–∏—è: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
    async function updateMarkerPos(marker, isPointA) {
        let pos = marker.getLatLng();
        document.getElementById(isPointA ? 'addr-from' : 'addr-to').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        let addr = await getAddress(pos.lat, pos.lng);
        
        if (isPointA) {
            orderData.from = addr;
            document.getElementById('addr-from').innerText = addr;
        } else {
            orderData.to = addr;
            document.getElementById('addr-to').innerText = addr;
        }

        // –ï—Å–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ —Å—Ç–æ—è—Ç, –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç
        if (markerA && markerB) {
            await drawRouteAndCalculate(markerA.getLatLng(), markerB.getLatLng());
        }
    }

    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
    map.on('click', async function(e) {
        if (!markerA) {
            // draggable: true —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ç–∞—Å–∫–∞—Ç—å –º–∞—Ä–∫–µ—Ä
            markerA = L.marker(e.latlng, {icon: iconA, draggable: true}).addTo(map);
            document.getElementById('sheet').classList.add('active'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à—Ç–æ—Ä–∫—É
            document.getElementById('reset-btn').classList.add('active'); // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞
            
            // –ï—Å–ª–∏ –º–∞—Ä–∫–µ—Ä –ø–µ—Ä–µ—Ç–∞—â–∏–ª–∏ –∏ –æ—Ç–ø—É—Å—Ç–∏–ª–∏
            markerA.on('dragend', function() { updateMarkerPos(markerA, true); });
            await updateMarkerPos(markerA, true);
            
        } else if (!markerB) {
            markerB = L.marker(e.latlng, {icon: iconB, draggable: true}).addTo(map);
            
            markerB.on('dragend', function() { updateMarkerPos(markerB, false); });
            await updateMarkerPos(markerB, false);
        }
    });

    // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—Ç—ã (–ö–Ω–æ–ø–∫–∞ –ö—Ä–µ—Å—Ç–∏–∫)
    function resetMap() {
        if(markerA) map.removeLayer(markerA);
        if(markerB) map.removeLayer(markerB);
        if(routeLine) map.removeLayer(routeLine);
        markerA = markerB = routeLine = null;
        orderData = { from: "", to: "", price: 0, distance: 0 };
        
        document.getElementById('sheet').classList.remove('active');
        document.getElementById('reset-btn').classList.remove('active');
        document.getElementById('addr-from').innerText = "–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É...";
        document.getElementById('addr-to').innerText = "–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É...";
        document.getElementById('price-val').innerText = "~ —Ä—É–±.";
    }

    // –†–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞
    async function drawRouteAndCalculate(start, end) {
        if(routeLine) map.removeLayer(routeLine); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–∏–Ω–∏—é
        document.getElementById('price-val').innerText = "–°—á–∏—Ç–∞–µ–º...";
        document.getElementById('order-btn').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞...";
        document.getElementById('order-btn').disabled = true;

        try {
            let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`);
            let data = await res.json();
            
            if(data.routes && data.routes.length > 0) {
                let route = data.routes[0];
                let distanceKm = (route.distance / 1000).toFixed(1);
                orderData.distance = distanceKm;
                
                let calculatedPrice = Math.round(100 + (distanceKm * 20));
                orderData.price = calculatedPrice;
                document.getElementById('price-val').innerText = calculatedPrice + " —Ä—É–±.";

                routeLine = L.geoJSON(route.geometry, { style: {color: '#007aff', weight: 5, opacity: 0.8} }).addTo(map);
                
                document.getElementById('order-btn').innerText = "–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏";
                document.getElementById('order-btn').disabled = false;
            }
        } catch(e) {
            document.getElementById('price-val').innerText = "–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞";
        }
    }

    function sendOrder() {
        if(orderData.from && orderData.to && orderData.price > 0) {
            tg.sendData(JSON.stringify(orderData));
            tg.close();
        } else {
            // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö
            tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –æ–±–µ —Ç–æ—á–∫–∏ (–û—Ç–∫—É–¥–∞ –∏ –ö—É–¥–∞) –∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã.");
        }
    }
</script>
</body>
</html>
