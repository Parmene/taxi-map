<!DOCTYPE html>
<html>
<head>
    <title>–ú–∞—Ä—à—Ä—É—Ç –∑–∞–∫–∞–∑–∞</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: #f3f3f2; }
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        .bottom-sheet {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; border-radius: 20px 20px 0 0;
            padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); z-index: 1000;
        }
        .address-box { margin-bottom: 12px; font-size: 16px; font-weight: 500; background: #f5f5f5; padding: 12px; border-radius: 10px;}
        .title { font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 4px;}
        
        .main-btn {
            width: 100%; background: #000; color: white; border: none;
            padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer;
        }
        
        .custom-icon { background: none; border: none; }
        .marker-a { background: #000; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white;}
        .marker-b { background: #ffde00; color: black; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white;}
    </style>
</head>
<body>

<div id="map"></div>

<div class="bottom-sheet" id="sheet">
    <div class="title">üìç –ó–∞–±—Ä–∞—Ç—å –ø–∞—Å—Å–∞–∂–∏—Ä–∞:</div>
    <div class="address-box" id="addr-from">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div class="title">üèÅ –û—Ç–≤–µ–∑—Ç–∏:</div>
    <div class="address-box" id="addr-to">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <button class="main-btn" onclick="tg.close()">–ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready();

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ —Å—Å—ã–ª–∫–∏, –∫–æ—Ç–æ—Ä—É—é –ø—Ä–∏—à–ª–µ—Ç –±–æ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: ?from=58.6,49.6&to=58.61,49.65)
    const urlParams = new URLSearchParams(window.location.search);
    const fromParam = urlParams.get('from');
    const toParam = urlParams.get('to');

    const map = L.map('map', {zoomControl: false}).setView([58.6035, 49.6680], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

    const iconA = L.divIcon({className: 'custom-icon', html: '<div class="marker-a">A</div>', iconSize: [30, 30]});
    const iconB = L.divIcon({className: 'custom-icon', html: '<div class="marker-b">B</div>', iconSize: [30, 30]});

    async function getAddress(lat, lon, elementId) {
        try {
            let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ru`);
            let data = await res.json();
            if(data.address) {
                document.getElementById(elementId).innerText = (data.address.road || data.address.suburb || "–¢–æ—á–∫–∞") + (data.address.house_number ? ", " + data.address.house_number : "");
            } else {
                document.getElementById(elementId).innerText = "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ";
            }
        } catch(e) { document.getElementById(elementId).innerText = "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ"; }
    }

    async function drawRoute() {
        if (!fromParam || !toParam) {
            document.getElementById('addr-from').innerText = "–û—à–∏–±–∫–∞: –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç"; return;
        }

        let [latA, lonA] = fromParam.split(',');
        let [latB, lonB] = toParam.split(',');

        L.marker([latA, lonA], {icon: iconA}).addTo(map);
        L.marker([latB, lonB], {icon: iconB}).addTo(map);

        getAddress(latA, lonA, 'addr-from');
        getAddress(latB, lonB, 'addr-to');

        try {
            let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${lonA},${latA};${lonB},${latB}?overview=full&geometries=geojson`);
            let data = await res.json();
            if(data.routes && data.routes.length > 0) {
                let routeLine = L.geoJSON(data.routes[0].geometry, { style: {color: '#007aff', weight: 5, opacity: 0.8} }).addTo(map);
                map.fitBounds(routeLine.getBounds(), {padding: [30, 30]});
            }
        } catch(e) {}
    }

    drawRoute();
</script>
</body>
</html>
