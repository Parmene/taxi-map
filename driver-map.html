<!DOCTYPE html>
<html>
<head>
    <title>–ú–∞—Ä—à—Ä—É—Ç –∑–∞–∫–∞–∑–∞</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background: #f3f3f2; overflow: hidden;}
        #map { height: 100vh; width: 100vw; z-index: 1; }
        
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); z-index: 1000; }
        .address-box { margin-bottom: 12px; font-size: 16px; font-weight: 500; background: #f5f5f5; padding: 12px; border-radius: 10px;}
        .title { font-size: 12px; color: #888; text-transform: uppercase; margin-bottom: 4px;}
        
        /* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—è–µ—Ç —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ */
        .main-btn { width: 100%; color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; transition: 0.3s;}
        .btn-arrive { background: #007aff; }
        .btn-start { background: #ffcc00; color: black;}
        .btn-finish { background: #34c759; }
        
        .custom-icon { background: none; border: none; }
        .marker-a { background: #000; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white;}
        .marker-b { background: #ffde00; color: black; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white;}
    </style>
</head>
<body>

<div id="map"></div>

<div class="bottom-sheet" id="sheet">
    <div class="title">üìç –û—Ç–∫—É–¥–∞:</div>
    <div class="address-box" id="addr-from">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <div class="title">üèÅ –ö—É–¥–∞:</div>
    <div class="address-box" id="addr-to">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <!-- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–µ–∑–¥–∫–æ–π -->
    <button class="main-btn btn-arrive" id="action-btn" onclick="nextStatus()">üìç –Ø –Ω–∞ –º–µ—Å—Ç–µ</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); tg.ready();

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –∏–∑ —Å—Å—ã–ª–∫–∏, –∫–æ—Ç–æ—Ä—É—é —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ü–∏—Ç–æ–Ω
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('id');
    const passTgId = urlParams.get('pass_id');
    const latA = urlParams.get('latA'), lonA = urlParams.get('lonA');
    const latB = urlParams.get('latB'), lonB = urlParams.get('lonB');
    const textFrom = decodeURIComponent(urlParams.get('addrA'));
    const textTo = decodeURIComponent(urlParams.get('addrB'));

    document.getElementById('addr-from').innerText = textFrom || "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ê";
    document.getElementById('addr-to').innerText = textTo || "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ë";

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–µ
    let currentStatus = 'arriving'; // arriving -> waiting -> in_trip -> finished

    function nextStatus() {
        let btn = document.getElementById('action-btn');
        let signalData = { type: "driver_action", order_id: orderId, pass_id: passTgId, action: "" };

        if (currentStatus === 'arriving') {
            signalData.action = "arrived"; // –°–∏–≥–Ω–∞–ª –±–æ—Ç—É: "–Ø –ø—Ä–∏–µ—Ö–∞–ª"
            currentStatus = 'waiting';
            btn.className = "main-btn btn-start";
            btn.innerText = "üöô –ù–∞—á–∞—Ç—å –ø–æ–µ–∑–¥–∫—É";
            tg.sendData(JSON.stringify(signalData)); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –±–æ—Ç—É –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—è –∫–∞—Ä—Ç—É! (—Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ TG API, –µ—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–∏–¥–µ—Ç—Å—è –∑–∞–∫—Ä—ã–≤–∞—Ç—å)
            
        } else if (currentStatus === 'waiting') {
            signalData.action = "started"; // –°–∏–≥–Ω–∞–ª –±–æ—Ç—É: "–ü–æ–µ—Ö–∞–ª–∏"
            currentStatus = 'in_trip';
            btn.className = "main-btn btn-finish";
            btn.innerText = "üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–µ–∑–¥–∫—É";
            tg.sendData(JSON.stringify(signalData));
            
        } else if (currentStatus === 'in_trip') {
            signalData.action = "finished"; // –°–∏–≥–Ω–∞–ª –±–æ—Ç—É: "–ó–∞–≤–µ—Ä—à–∏–ª"
            tg.sendData(JSON.stringify(signalData));
            tg.close(); // –ù–∞ —Ñ–∏–Ω–∏—à–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É
        }
    }

    const map = L.map('map', {zoomControl: false}).setView([58.6035, 49.6680], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

    if (latA && lonA && latB && lonB) {
        L.marker([latA, lonA], {icon: L.divIcon({className: 'custom-icon', html: '<div class="marker-a">A</div>', iconSize: [30, 30]})}).addTo(map);
        L.marker([latB, lonB], {icon: L.divIcon({className: 'custom-icon', html: '<div class="marker-b">B</div>', iconSize: [30, 30]})}).addTo(map);
        
        // –†–∏—Å—É–µ–º –º–∞—Ä—à—Ä—É—Ç
        fetch(`https://router.project-osrm.org/route/v1/driving/${lonA},${latA};${lonB},${latB}?overview=full&geometries=geojson`)
        .then(res => res.json())
        .then(data => {
            if(data.routes && data.routes.length > 0) {
                let routeLine = L.geoJSON(data.routes[0].geometry, { style: {color: '#007aff', weight: 5, opacity: 0.8} }).addTo(map);
                map.fitBounds(routeLine.getBounds(), {padding: [30, 30]});
            }
        });
    }
</script>
</body>
</html>
